<!-- vim: set tabstop=2 softtabstop=2 shiftwidth=2 noexpandtab textwidth=80 : -->

<!--
===============================================================================
PLANTILLA: CAMBIO DE CONTRASEÑA DE USUARIO
===============================================================================
Permite al usuario o al administrador cambiar la contraseña de una cuenta.
Incluye validación HTML5 y comprobación de coincidencia entre los dos campos.
===============================================================================
-->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(
        title='Cambiar contraseña',
        content=~{::main},
        scripts=~{::script}
      )}">

<main>
	<section class="text-center mb-2">
		<h1>Cambiar contraseña</h1>
		<p class="text-muted">
			Introduce una nueva contraseña segura y confírmala para continuar.
		</p>
	</section>

	<form th:action="@{/user/change-password}" method="post" novalidate>
		<!-- ID del usuario -->
		<input type="hidden" name="id" th:value="${user.id}" />

		<!-- Campo visible solo si el usuario logado es administrador -->
		<div th:if="${loggedUser.isAdmin}">
			<p class="text-muted">
				Estás cambiando la contraseña de otro usuario:
				<span th:text="${user.email}">usuario@example.com</span>
			</p>
		</div>

		<!-- Nueva contraseña -->
		<label for="password">Nueva contraseña *</label>
		<input id="password" type="password" name="passwordPlain"
		       placeholder="Introduce una nueva contraseña"
		       required minlength="8" maxlength="80" />

		<!-- Confirmación -->
		<label for="passwordConfirm">Confirmar contraseña *</label>
		<input id="passwordConfirm" type="password" name="passwordConfirm"
		       placeholder="Repite la nueva contraseña"
		       required minlength="8" maxlength="80" />

		<!-- Mensaje de error local (se mostrará si no coinciden) -->
		<p id="passwordError" class="text-error hidden">
			Las contraseñas no coinciden.
		</p>

		<!-- Botones -->
		<div class="text-center mt-4">
			<button type="submit" class="btn">Guardar nueva contraseña</button>
			<a class="btn btn-muted" th:href="@{/main}">Cancelar</a>
		</div>
	</form>
</main>

<!-- =======================
     BLOQUE DE SCRIPTS INYECTABLE
     ======================= -->
<script>
/**
 * Validación de coincidencia de contraseñas en cliente.
 * Impide enviar el formulario si los campos no coinciden.
 */
document.addEventListener("DOMContentLoaded", () => {
	const form = document.querySelector("form");
	const pass1 = document.getElementById("password");
	const pass2 = document.getElementById("passwordConfirm");
	const errorMsg = document.getElementById("passwordError");

	form.addEventListener("submit", (e) => {
		if (pass1.value !== pass2.value) {
			e.preventDefault();
			errorMsg.classList.remove("hidden");
			pass1.focus();
		} else {
			errorMsg.classList.add("hidden");
		}
	});
});
</script>

</html>

<!--
===============================================================================
NOTAS PEDAGÓGICAS
===============================================================================
1. SEGURIDAD Y FLUJO DE DATOS
------------------------------
La contraseña nunca se almacena ni transmite en texto plano más allá del POST
inicial. El backend (UserService + PasswordService) se encarga de generar un
nuevo `salt` y su correspondiente `hash`.

2. VALIDACIÓN DEL LADO DEL CLIENTE
-----------------------------------
Antes de enviar el formulario, se verifica que ambos campos coincidan.
Esto mejora la experiencia del usuario y reduce errores.

3. VALIDACIÓN DEL LADO DEL SERVIDOR
-----------------------------------
El controlador vuelve a comprobar la coincidencia y realiza el cambio real.
Nunca se confía solo en la validación cliente.

4. ACCESO CONDICIONAL
----------------------
- Si el usuario logado no es admin, solo puede cambiar su propia contraseña.
- Si es admin, puede cambiar la contraseña de otros usuarios, y se muestra un
  aviso con el email del usuario afectado.

5. DISEÑO Y ACCESIBILIDAD
--------------------------
Usa estilos definidos en `base.css`:
 - Campos con padding cómodo y bordes suaves.
 - Botones accesibles y coherentes con el resto de vistas.
 - Mensaje de error con clase `.text-error` (color rojo definido en CSS).

6. OBJETIVO PEDAGÓGICO
------------------------
Esta plantilla enseña cómo combinar:
 - Validación HTML5 nativa.
 - Verificación dinámica con JavaScript.
 - Renderizado condicional con Thymeleaf.
===============================================================================
-->